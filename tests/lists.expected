
Desugared:

	(letrec
	 (types
	  ((list
	    (lam a
	     (rec list
	      (union
	       ((Cons (record (types ()) (values ((tl list) (hd a)))))
	        (Nil (record (types ()) (values ()))))))))))
	 (values ())
	 (letrec (types ())
	  (values
	   ((length
	     (:
	      (fn lst
	       ((match
	         ((Cons (l ((((. add) int) (Integer 1)) (length ((. tl) l)))))
	          (Nil (_ (Integer 0)))))
	        lst))
	      (all a ((list a) -> int))))))
	  (length
	   ((fn x (Cons x))
	    (letrec (types ())
	     (values
	      ((hd (Integer 4))
	       (tl
	        ((fn x (Cons x))
	         (letrec (types ())
	          (values
	           ((hd (Integer 0))
	            (tl
	             ((fn x (Cons x))
	              (letrec (types ())
	               (values ((hd (Integer 1)) (tl ((fn x (Nil x)) {}))))
	               (((.= hd) (((.= tl) {}) tl)) hd))))))
	          (((.= hd) (((.= tl) {}) tl)) hd))))))
	     (((.= hd) (((.= tl) {}) tl)) hd))))))

inferred type:

	int

Runtime term:

	(LetRec
	 (((1
	    (Lam
	     (1 ()
	      (App
	       ((Match
	         (BLabel
	          (lm_cases
	           ((Cons
	             (BLeaf
	              (Lam
	               (2 ()
	                (App
	                 ((App
	                   ((App
	                     ((GetField add)
	                      (Record
	                       ((add (Prim <fun>)) (div (Prim <fun>))
	                        (mul (Prim <fun>)) (rem (Prim <fun>))
	                        (sub (Prim <fun>))))))
	                    (Const (Integer 1))))
	                  (App ((Var 2) (App ((GetField tl) (Var 0)))))))))))
	            (Nil (BLeaf (Lam (0 () (Const (Integer 0))))))))
	          (lm_default ())))
	        (Var 0)))))))
	  (App
	   ((Var 0)
	    (App
	     ((Lam (0 () (Ctor (Cons (Var 0)))))
	      (LetRec
	       (((0 (Const (Integer 4)))
	         (0
	          (App
	           ((Lam (0 () (Ctor (Cons (Var 0)))))
	            (LetRec
	             (((0 (Const (Integer 0)))
	               (0
	                (App
	                 ((Lam (0 () (Ctor (Cons (Var 0)))))
	                  (LetRec
	                   (((0 (Const (Integer 1)))
	                     (0
	                      (App ((Lam (0 () (Ctor (Nil (Var 0))))) (Record ())))))
	                    (App
	                     ((App
	                       ((Lam
	                         (0 ()
	                          (Lam
	                           (1 ()
	                            (Update (old (Var 1)) (label hd) (field (Var 0)))))))
	                        (App
	                         ((App
	                           ((Lam
	                             (0 ()
	                              (Lam
	                               (1 ()
	                                (Update (old (Var 1)) (label tl)
	                                 (field (Var 0)))))))
	                            (Record ())))
	                          (Var 1)))))
	                      (Var 0)))))))))
	              (App
	               ((App
	                 ((Lam
	                   (0 ()
	                    (Lam
	                     (1 () (Update (old (Var 1)) (label hd) (field (Var 0)))))))
	                  (App
	                   ((App
	                     ((Lam
	                       (0 ()
	                        (Lam
	                         (1 ()
	                          (Update (old (Var 1)) (label tl) (field (Var 0)))))))
	                      (Record ())))
	                    (Var 1)))))
	                (Var 0)))))))))
	        (App
	         ((App
	           ((Lam
	             (0 ()
	              (Lam (1 () (Update (old (Var 1)) (label hd) (field (Var 0)))))))
	            (App
	             ((App
	               ((Lam
	                 (0 ()
	                  (Lam
	                   (1 () (Update (old (Var 1)) (label tl) (field (Var 0)))))))
	                (Record ())))
	              (Var 1)))))
	          (Var 0)))))))))))

Evaluated:

	(Const (Integer 3))
